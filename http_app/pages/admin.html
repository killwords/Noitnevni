<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WAF ç®¡ç†é¢æ¿</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #3d3d3d;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #404040;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #2d1b69 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 1024px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px var(--shadow);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .panel:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px var(--shadow);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border);
    }

    .panel-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: var(--accent);
      border-radius: 2px;
    }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-success {
      background: var(--success);
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .status-item {
      background: var(--bg-tertiary);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }

    .status-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .status-value {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .status-good {
      color: var(--success);
    }

    .status-warning {
      color: var(--warning);
    }

    .status-error {
      color: var(--danger);
    }

    .dict-management {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
      align-items: start;
    }

    @media (max-width: 768px) {
      .dict-management {
        grid-template-columns: 1fr;
      }
    }

    .dict-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    select, input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    textarea {
      width: 100%;
      height: 300px;
      padding: 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9rem;
      resize: vertical;
      transition: all 0.3s ease;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-group .btn {
      flex: 1;
      min-width: 120px;
      justify-content: center;
    }

    .config-management {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .config-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    pre {
      background: var(--bg-tertiary);
      padding: 20px;
      border-radius: 12px;
      overflow-x: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9rem;
      line-height: 1.4;
      max-height: 400px;
      overflow-y: auto;
    }

    .icon {
      width: 20px;
      height: 20px;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ›¡ï¸ WAF ç®¡ç†é¢æ¿</h1>
      <p>Noitnevniåº”ç”¨é˜²ç«å¢™ç®¡ç†ä¸ç›‘æ§ç³»ç»Ÿ</p>
    </div>

    <div class="dashboard">
      <!-- ç³»ç»ŸçŠ¶æ€é¢æ¿ -->
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
          <button class="btn" id="btn-status">
            <span class="icon">ğŸ”„</span> åˆ·æ–°çŠ¶æ€
          </button>
        </div>
        
        <div class="status-grid" id="status-grid">
          <div class="status-item">
            <div class="status-label">CPU ä½¿ç”¨ç‡</div>
            <div class="status-value status-warning" id="cpu-status">N/A</div>
          </div>
          <div class="status-item">
            <div class="status-label">å†…å­˜ä½¿ç”¨ç‡</div>
            <div class="status-value status-warning" id="memory-status">N/A</div>
          </div>
          <div class="status-item">
            <div class="status-label">WAF çŠ¶æ€</div>
            <div class="status-value status-good" id="waf-status">æ­£å¸¸</div>
          </div>
          <div class="status-item">
            <div class="status-label">ç½‘ç«™çŠ¶æ€</div>
            <div class="status-value status-error" id="website-status">å¼‚å¸¸</div>
          </div>
        </div>

        <div class="form-group">
          <label>èµ„æºä½¿ç”¨ï¼ˆæŠ˜çº¿å›¾ï¼Œæœ€è¿‘æ•°æ®ï¼‰ï¼š</label>
          <div style="display:flex;gap:12px;flex-direction:column;">
            <div style="display:flex;gap:12px;align-items:center;">
              <label style="min-width:140px;">è‡ªåŠ¨åˆ·æ–°ï¼ˆç§’ï¼‰:</label>
              <select id="auto-refresh-select">
                <option value="0">å…³é—­</option>
                <option value="5" selected>5</option>
                <option value="10">10</option>
                <option value="30">30</option>
                <option value="60">60</option>
              </select>
              <button class="btn" id="btn-refresh-metrics">åˆ·æ–°å›¾è¡¨</button>
              <div style="margin-left:auto;color:var(--text-secondary);">é‡‡æ ·é—´éš”ï¼š5sï¼ˆæœåŠ¡å™¨ç«¯ï¼‰</div>
            </div>
            <canvas id="cpuMemChart" height="120"></canvas>
            <canvas id="diskChart" height="80"></canvas>
            <canvas id="netChart" height="120"></canvas>
          </div>
        </div>

        <div class="form-group">
          <label>è¯¦ç»†çŠ¶æ€ä¿¡æ¯ï¼š</label>
          <pre id="status-details">ç‚¹å‡»åˆ·æ–°çŠ¶æ€è·å–è¯¦ç»†ä¿¡æ¯...</pre>
        </div>
      </div>

      <!-- å­—å…¸ç®¡ç†é¢æ¿ -->
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">ğŸ“ å­—å…¸ç®¡ç†</h2>
          <div class="btn-group">
            <button class="btn btn-success" id="btn-save-dict">
              <span class="icon">ğŸ’¾</span> ä¿å­˜
            </button>
          </div>
        </div>

        <div class="dict-management">
          <div class="dict-controls">
            <div class="form-group">
              <label>é€‰æ‹©å­—å…¸æ–‡ä»¶ï¼š</label>
              <select id="dict-list">
                <option value="">åŠ è½½ä¸­...</option>
              </select>
            </div>
            
            <div class="btn-group">
              <button class="btn" id="btn-load-dict">
                <span class="icon">ğŸ“¥</span> åŠ è½½
              </button>
              <button class="btn btn-secondary" id="btn-new-dict">
                <span class="icon">ğŸ†•</span> æ–°å»º
              </button>
            </div>

            <div class="form-group" id="new-dict-group" style="display: none;">
              <label>æ–°å­—å…¸æ–‡ä»¶åï¼š</label>
              <input type="text" id="new-dict-name" placeholder="è¾“å…¥æ–‡ä»¶å...">
              <button class="btn btn-success" id="btn-create-dict" style="margin-top: 8px;">
                <span class="icon">âœ…</span> åˆ›å»º
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>å­—å…¸å†…å®¹ï¼š</label>
            <textarea id="dict-content" placeholder="å­—å…¸å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- é…ç½®ç®¡ç†é¢æ¿ -->
    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">âš™ï¸ é…ç½®ç®¡ç†</h2>
        <div class="config-actions">
          <button class="btn" id="btn-load-config">
            <span class="icon">ğŸ“¥</span> åŠ è½½é…ç½®
          </button>
          <button class="btn btn-success" id="btn-save-config">
            <span class="icon">ğŸ’¾</span> ä¿å­˜é…ç½®
          </button>
        </div>
      </div>

      <div class="config-management">
        <textarea id="config-content" placeholder="é…ç½®æ–‡ä»¶å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
      </div>
    </div>

    <div class="footer">
      <p>WAF Noitnevni Â© 2024 | å®‰å…¨é˜²æŠ¤ç³»ç»Ÿ | https://www.github.com/killwords/Noitnevni</p>
    </div>
  </div>

  <script>
    // API è°ƒç”¨å‡½æ•°
    async function api(path, method = 'GET', body = null) {
      const opts = { method, headers: {} };
      if (body) { 
        opts.body = JSON.stringify(body); 
        opts.headers['Content-Type'] = 'application/json'; 
      }
      const res = await fetch(path, opts);
      const text = await res.text();
      try { return JSON.parse(text); } catch (e) { return text; }
    }

    // çŠ¶æ€ç®¡ç†
    let currentStatus = null;

    // åˆ·æ–°çŠ¶æ€
    function _wafReachableText(v){
      if(v === true) return 'å¯è¾¾ (TCP å·²è¿æ¥)';
      if(v === false) return 'ä¸å¯è¾¾ (è¿æ¥å¤±è´¥)';
      if(v === 'unknown') return 'æœªçŸ¥ (é…ç½®ç¼ºå¤±æˆ–è¯»å–å¤±è´¥)';
      return String(v);
    }

    async function refreshStatus(){
      try{
        const res = await api('/api/status');
        if(!res || !res.ok){
          document.getElementById('status-details').textContent = 'è·å–çŠ¶æ€å¤±è´¥: ' + JSON.stringify(res);
          return;
        }
        const s = res.status || {};

        // æ›´æ–°çŠ¶æ€å¡ç‰‡
        document.getElementById('cpu-status').textContent =
          s.cpu_percent === 'N/A' ? 'N/A' : `${s.cpu_percent}%`;
        document.getElementById('memory-status').textContent =
          s.memory_percent === 'N/A' ? 'N/A' : `${s.memory_percent}%`;

        // WAF çŠ¶æ€ï¼ˆå‹å¥½æ˜¾ç¤ºï¼‰
        const wafStatus = document.getElementById('waf-status');
        if (s.waf_reachable === true) {
          wafStatus.textContent = 'æ­£å¸¸';
          wafStatus.className = 'status-value status-good';
        } else if (s.waf_reachable === false) {
          wafStatus.textContent = 'ä¸å¯è¾¾';
          wafStatus.className = 'status-value status-error';
        } else {
          wafStatus.textContent = 'æœªçŸ¥';
          wafStatus.className = 'status-value status-warning';
        }

        // ç½‘ç«™çŠ¶æ€
        const websiteStatus = document.getElementById('website-status');
        if (s.index_exists) {
          websiteStatus.textContent = 'æ­£å¸¸';
          websiteStatus.className = 'status-value status-good';
        } else {
          websiteStatus.textContent = 'å¼‚å¸¸';
          websiteStatus.className = 'status-value status-error';
        }

        // è¯¦ç»†çŠ¶æ€
        document.getElementById('status-details').textContent = JSON.stringify(res, null, 2);
      } catch (error) {
        document.getElementById('status-details').textContent = `é”™è¯¯: ${error.message}`;
      }
    }

    // å­—å…¸ç®¡ç†åŠŸèƒ½
    async function loadDictList() {
      const data = await api('/api/list_dicts');
      const select = document.getElementById('dict-list');
      
      if (data && data.files) {
        select.innerHTML = '';
        data.files.forEach(file => {
          const option = document.createElement('option');
          option.value = file;
          option.textContent = file;
          select.appendChild(option);
        });
      }
    }

    async function loadDict() {
      const select = document.getElementById('dict-list');
      const name = select.value;
      if (!name) return alert('è¯·é€‰æ‹©å­—å…¸æ–‡ä»¶');
      
      const data = await api('/api/get_dict?name=' + encodeURIComponent(name));
      if (data.ok) {
        document.getElementById('dict-content').value = data.content;
      } else {
        alert('åŠ è½½å¤±è´¥: ' + data.error);
      }
    }

    async function saveDict() {
      const select = document.getElementById('dict-list');
      const name = select.value;
      const content = document.getElementById('dict-content').value;
      
      if (!name) return alert('è¯·é€‰æ‹©å­—å…¸æ–‡ä»¶');
      if (!content) return alert('å­—å…¸å†…å®¹ä¸èƒ½ä¸ºç©º');
      
      const data = await api('/api/save_dict', 'POST', { name, content });
      if (data.ok) {
        alert('ä¿å­˜æˆåŠŸï¼å­—å…¸å·²è½¬ä¸ºå°å†™æ ¼å¼ã€‚');
        await loadDictList();
      } else {
        alert('ä¿å­˜å¤±è´¥: ' + data.error);
      }
    }

    // é…ç½®ç®¡ç†åŠŸèƒ½
    async function loadConfig() {
      const data = await api('/api/get_config');
      if (data.ok) {
        document.getElementById('config-content').value = 
          JSON.stringify(data.config, null, 2);
      } else {
        alert('åŠ è½½é…ç½®å¤±è´¥: ' + data.error);
      }
    }

    async function saveConfig() {
      try {
        const content = document.getElementById('config-content').value;
        const config = JSON.parse(content);
        const data = await api('/api/save_config', 'POST', config);
        
        if (data.ok) {
          alert('é…ç½®ä¿å­˜æˆåŠŸï¼');
        } else {
          alert('ä¿å­˜å¤±è´¥: ' + data.error);
        }
      } catch (error) {
        alert('JSON æ ¼å¼é”™è¯¯: ' + error.message);
      }
    }

    // æ–°å»ºå­—å…¸åŠŸèƒ½
    function showNewDictInput() {
      document.getElementById('new-dict-group').style.display = 'block';
    }

    async function createNewDict() {
      const name = document.getElementById('new-dict-name').value;
      if (!name) return alert('è¯·è¾“å…¥æ–‡ä»¶å');
      if (!name.endsWith('.txt')) {
        alert('æ–‡ä»¶åå¿…é¡»ä»¥ .txt ç»“å°¾');
        return;
      }
      
      const data = await api('/api/save_dict', 'POST', { name, content: '' });
      if (data.ok) {
        alert('å­—å…¸æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼');
        document.getElementById('new-dict-group').style.display = 'none';
        document.getElementById('new-dict-name').value = '';
        await loadDictList();
      } else {
        alert('åˆ›å»ºå¤±è´¥: ' + data.error);
      }
    }

    // äº‹ä»¶ç›‘å¬
    document.getElementById('btn-status').addEventListener('click', refreshStatus);
    document.getElementById('btn-load-dict').addEventListener('click', loadDict);
    document.getElementById('btn-save-dict').addEventListener('click', saveDict);
    document.getElementById('btn-load-config').addEventListener('click', loadConfig);
    document.getElementById('btn-save-config').addEventListener('click', saveConfig);
    document.getElementById('btn-new-dict').addEventListener('click', showNewDictInput);
    document.getElementById('btn-create-dict').addEventListener('click', createNewDict);

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      await loadDictList();
      await refreshStatus();
    });

    // --- Metrics charts ---
    let cpuMemChart = null;
    let diskChart = null;
    let netChart = null;
    let metricsIntervalId = null;

    function humanBytes(n){
      if (n === null || n === undefined) return '-';
      if (typeof n !== 'number') return String(n);
      if (n > 1024*1024) return (n/1024/1024).toFixed(2) + ' MB/s';
      if (n > 1024) return (n/1024).toFixed(1) + ' KB/s';
      return n.toFixed(0) + ' B/s';
    }

    function initCharts(){
      if (typeof Chart === 'undefined'){
        // Chart.js not loaded
        document.getElementById('cpuMemChart').outerHTML = '<div style="color:var(--text-secondary)">Chart.js æœªåŠ è½½ï¼ŒæŠ˜çº¿å›¾ä¸å¯ç”¨ã€‚</div>';
        document.getElementById('diskChart').outerHTML = '';
        document.getElementById('netChart').outerHTML = '';
        return;
      }
      const ctx1 = document.getElementById('cpuMemChart').getContext('2d');
      cpuMemChart = new Chart(ctx1, {
        type: 'line',
        data: { labels: [], datasets: [
          { label: 'CPU %', data: [], borderColor: '#f97316', fill: false, tension: 0.2, yAxisID: 'y' },
          { label: 'Memory %', data: [], borderColor: '#60a5fa', fill: false, tension: 0.2, yAxisID: 'y' }
        ]},
        options: { scales: { y: { beginAtZero:true, max:100 } }, plugins: { legend:{position:'top'} } }
      });

      const ctx2 = document.getElementById('diskChart').getContext('2d');
      diskChart = new Chart(ctx2, {
        type: 'line', data: { labels: [], datasets: [
          { label: 'Disk %', data: [], borderColor: '#34d399', fill:false, tension:0.2 }
        ]}, options: { scales:{ y:{ beginAtZero:true, max:100 } }, plugins:{ legend:{display:false} } }
      });

      const ctx3 = document.getElementById('netChart').getContext('2d');
      netChart = new Chart(ctx3, {
        type: 'line', data: { labels: [], datasets: [
          { label: 'Net Sent', data: [], borderColor: '#a78bfa', fill:false, tension:0.2 },
          { label: 'Net Recv', data: [], borderColor: '#f472b6', fill:false, tension:0.2 }
        ]}, options: { plugins:{ tooltip:{ callbacks:{ label: function(context){ return humanBytes(context.raw); } } }, legend:{position:'top'} }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    async function fetchAndUpdateMetrics(){
      try{
        const r = await api('/api/metrics');
        if(!r || !r.ok) return;
        const metrics = r.metrics || [];
        if(metrics.length === 0){
          // no data yet
          return;
        }
        const labels = metrics.map(m => new Date(m.ts*1000).toLocaleTimeString());

        // cpu/mem
        cpuMemChart.data.labels = labels;
  cpuMemChart.data.datasets[0].data = metrics.map(m => (typeof m.cpu === 'number' ? m.cpu : null));
  cpuMemChart.data.datasets[1].data = metrics.map(m => (typeof m.memory === 'number' ? m.memory : null));
        cpuMemChart.update();

        // disk
        diskChart.data.labels = labels;
  diskChart.data.datasets[0].data = metrics.map(m => (typeof m.disk_percent === 'number' ? m.disk_percent : null));
        diskChart.update();

        // net
        netChart.data.labels = labels;
  netChart.data.datasets[0].data = metrics.map(m => (typeof m.net_sent_bps === 'number' ? m.net_sent_bps : null));
  netChart.data.datasets[1].data = metrics.map(m => (typeof m.net_recv_bps === 'number' ? m.net_recv_bps : null));
        netChart.update();
      }catch(e){
        // ignore
      }
    }

    function setupAutoRefresh(){
      const sel = document.getElementById('auto-refresh-select');
      const btn = document.getElementById('btn-refresh-metrics');
      btn.addEventListener('click', fetchAndUpdateMetrics);
      sel.addEventListener('change', ()=>{
        if(metricsIntervalId) clearInterval(metricsIntervalId);
        const val = parseInt(sel.value,10);
        if(val>0){ metricsIntervalId = setInterval(()=>{ fetchAndUpdateMetrics(); refreshStatus(); }, val*1000); }
      });
      // start default
      const defaultSec = parseInt(document.getElementById('auto-refresh-select').value,10);
      if(defaultSec>0){ metricsIntervalId = setInterval(()=>{ fetchAndUpdateMetrics(); refreshStatus(); }, defaultSec*1000); }
    }

    // init charts after DOM
    (function(){
      initCharts();
      fetchAndUpdateMetrics();
      setupAutoRefresh();
    })();
  </script>
</body>
</html>